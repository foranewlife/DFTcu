# DFTcu-QE 算法差异与实现逻辑技术总结

**版本**: v1.0 (2026-01-01)
**目标**: 记录 DFTcu 在实现与 QE 对齐过程中识别到的核心算法差异及解决方案。

## 1. 倒空间存储与计算模式
*   **QE (Gamma-only 优化)**:
    - **逻辑**: 利用 Hermitian 对称性 ($C_{-G} = C_G^*$)，仅存储 $G_z > 0$ 的半个 $G$ 球数据。
    - **计算**: 在计算内积 $\langle\psi|\phi\rangle$ 和电荷密度时，使用 `2 * Re(sum(...))` 补偿未存储的另一半。
*   **DFTcu (全网格复数存储)**:
    - **逻辑**: 存储全球网格的所有复数系数。这种方式虽然内存翻倍，但避免了复杂的条件分支逻辑，且对 FFT 和 cuBLAS 矩阵运算更具亲和力。
    - **对齐处理**: 在对比脚本中通过 `Hermitian Expansion` 将 QE 的半球数据还原至全球网格进行点对点验证。

## 2. 内存布局 (Memory Layout)
*   **差异**: QE 继承自 Fortran 的 Column-major 序，且其实空间网格导出到文本时存在 X-Y 轴交换。
*   **DFTcu**: 使用 C++ 标准的 Row-major 序（$z$ 轴是最内层循环）。
*   **对齐处理**: 确立了统一的映射公式：`qe_aligned = qe_raw.reshape(nr).transpose(1, 0, 2).flatten()`。

## 3. 正交化算法 (Orthogonalization)
*   **QE**: 默认使用 **Lowdin 正交化** ($S^{-1/2}$)。优点是能最大限度保留原子轨道初始特征，生成的能级波函数是对称的。
*   **DFTcu**: 目前实现的是 **Gram-Schmidt 正交化**。
*   **物理结论**: 虽然单条波函数 $\psi_i$ 会有差异，但两者生成的**占据态子空间**是等价的，因此总电荷密度 $\rho$ 和本征值 $\epsilon_i$ 理论上应该保持一致。

## 4. 数值稳定性阈值 (Numerical Thresholds)
*   **发现**: QE 在处理非线性泛函（如 LDA-PZ）时，内部硬编码了 `rho_threshold = 1e-10` 以防在真空区产生数值发散。
*   **DFTcu**: 原默认值为 `1e-16`。
*   **对齐处理**: 同步 DFTcu 的阈值为 `1e-10`，此操作直接将交换相关势 $V_{xc}$ 的对齐误差从 $10^{-6}$ 压制到了 $10^{-12}$。

## 5. 单位系统 (Unit Systems)
*   **QE**: 能量采用 Rydberg，长度采用 Bohr。
*   **DFTcu**: 外部 Python 层采用 Hartree 和 Angstrom（符合现代习惯），内部 C++ 核算时自动转换至 Bohr。
*   **关键因子**: 动能项 $T = \frac{1}{2}G^2$ (Ha) vs $T = G^2$ (Ry)；波函数相位因子 $i^l$ (QE) vs $(-i)^l$ (DFTcu 早期)。现已全部统一为 QE 约定。

## 6. 随机波函数生成 (Randomization)
*   **QE**: 采用带有动能衰减的平滑噪声：$\\psi(G) \propto \text{randy()} / (G^2 + 1.0)$。
*   **DFTcu**: 已完成对齐，放弃纯白噪声，引入动能缩放因子，显著提升了 SCF 的初始收敛性。

## 7. 非局部算符插值表 (External Table Injection)
*   **背景**: 为了达到 $10^{-14}$ 级的能级对齐精度，我们识别到径向傅里叶变换的数值积分（辛普森积分细节、Bessel 函数极限处理）是目前主要的误差源（约 $10^{-3} \sim 10^{-5}$ Ha）。
*   **当前对齐策略**: 引入了 `set_tab_beta` 接口，允许从 QE 导出的 `tab_beta` 数据中直接注入插值表。
*   **未来目标**: 这种“外部注入”是确保物理逻辑 100% 同步的过渡方案。未来 DFTcu 将实现自主的高精度高斯-勒让德积分或优化的辛普森逻辑，以摆脱对外部代码预处理数据的依赖，实现算法独立性。

---
**结论**: DFTcu 虽然在存储策略上选择了更现代、适合 GPU 吞吐的“全量模式”，但在物理本质（相位、积分、势场卷积、动能定义）上已实现了对 QE 的完全还原。
