# DFTcu-QE 对齐阶段性报告 (Phase 2: 算符与动能)

**日期**: 2026-01-01
**当前状态**: ✅ 动能算符 ($T\psi$) 点对点对齐成功；波函数相位对齐成功

## 1. 核心突破：同步导出验证 (Synchronized Export)
在验证算符 $H|\psi\rangle$ 时，我们发现 QE 内部在进入主循环前会执行 `rotate_wfc`（子空间旋转）。这导致直接拿初始原子轨道与 QE 导出的 $H\psi$ 对比会产生巨大误差。
- **解决方案**: 修改 QE 源码，实现在 `h_psi` 算符作用的**同一时刻**导出当前的 $\psi(G)$ 和 $T\psi(G)$。
- **结果**: 彻底排除了波函数演变的干扰，实现了算符级的纯粹验证。

## 2. 关键对齐数据 (Hartree a.u.)

| 验证项 | 误差 (MAE) | 误差 (Max Diff) | 结论 |
| :--- | :--- | :--- | :--- |
| **波函数 ($\\psi_G$)** | 7.14e-19 | 4.16e-17 | 相位因子 $i^l$ 完全对齐 |
| **动能项 ($T\\psi_G$)** | 1.78e-18 | 4.96e-17 | $G^2$ 单位与算符实现完美一致 |
| **总算符 ($H\\psi_G$)** | 4.99e-03 | 1.12e-01 | 仍存在约 0.1 Ha 偏差，待解决 |

## 3. 技术细节总结

### 3.1 Miller 指数重映射
- **挑战**: QE 与 DFTcu 的 G 向量在内存中的存储顺序完全不同（Shell-ordered vs Grid-ordered）。
- **实现**: 编写了 `compare_wfc_miller.py`，通过 Miller 索引 $(h, k, l)$ 建立哈希映射，实现了跨软件的点对点数值对比。

### 3.2 随机波函数平滑化 (Smoothing)
- **改进**: 将 DFTcu 的随机初始化从纯白噪声升级为 QE 风格的经验平滑算法。
- **公式**: $\\psi_{random}(G) \propto \frac{\text{randy()}}{G^2 + 1.0}$。
- **价值**: 显著降低了初始动能，提高了后续 SCF 的收敛稳定性。

### 3.3 自动网格工具
- **功能**: 实现了 `get_optimal_fft_grid`，根据 `ecutrho` 和晶格矢量自动计算符合 QE 逻辑且 FFT 友好的网格尺寸。

## 4. 下一阶段目标：势能算符与非局部项
目前 $H\\psi$ 剩下的 0.1 Ha 误差已精确定位至势能部分：
1. **非局部项 ($V_{nl}\\psi$)**: 尚未在对比脚本中激活，是目前最大的嫌疑项。
2. **局部势卷积 ($V_{loc}\\psi$)**: 需验证 FFT 变换过程中的 $1/N$ 归一化系数是否与 QE 严格匹配。

---
**核准**: Gemini Agent
**存档**: `/workplace/chenys/project/DFTcu/docs/PHASE2_OPERATOR_ALIGNMENT.md`
