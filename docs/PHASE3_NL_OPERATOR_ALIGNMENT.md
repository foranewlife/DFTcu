# DFTcu-QE 对齐阶段性报告 (Phase 3: 非局部算符与总算符)

**日期**: 2026-01-01
**当前状态**: ✅ 非局部算符 ($V_{nl}\psi$) 对齐成功；总算符 ($H\psi$) 对齐成功 ($10^{-11}$ Hartree)

## 1. 核心进展：非局部算符 (Non-local) 的精准对齐
在 Phase 2 的基础上，我们攻克了哈密顿量中最复杂的非局部项。通过在 QE `add_vuspsi` 模块中插入同步导出补丁，我们验证了 DFTcu 的投影算符逻辑。

### 1.1 关键修正：G 空间对称性还原
- **问题**: QE 的 Gamma 点计算仅存储和导出了半个 G 球的数据，直接导入 DFTcu 导致 $V_{nl}$ 计算缺失一半贡献，误差达 0.1 Ha。
- **解决**: 在对比脚本中实现了基于 **Hermitian 对称性** ($C_{-G} = C_G^*$) 的全网格填充逻辑。填充后，非局部项误差立即降至 $10^{-11}$。

## 2. 最终算符对齐数据 (Step 1 $H|\psi\rangle$)
单位：Hartree a.u.，基于同步导出的波函数进行点对点比对。

| 算符组分 | 最大绝对误差 (Max Diff) | 平均绝对误差 (MAE) | 状态 |
| :--- | :--- | :--- | :--- |
| **动能项 ($T\psi$)** | 4.96e-17 | 1.78e-18 | 完美 (极限) |
| **非局部项 ($V_{nl}\psi$)** | 6.51e-11 | 1.55e-11 | 高度对齐 |
| **总算符 ($H\psi$)** | **7.83e-11** | **2.00e-11** | **成功对齐** |

## 3. 代码库改进
- **`Hamiltonian` 增强**: `initialize_hamiltonian` 现在是完整的，自动集成 $V_{loc}, V_h, V_{xc}$ 及 $V_{nl}$。
- **Python 接口**: 导出了 `NonLocalPseudo` 类，允许在 Python 层进行细粒度的算符调试。
- **默认阈值**: 同步了 LDA-PZ 的密度阈值 ($1e-10$)，消除了势场在真空区的数值发散。

## 4. 下一阶段目标：子空间矩阵 $H_{ij}$
算符对齐成功意味着 $H|\psi\rangle$ 的映射是正确的。接下来的任务是验证投影到子空间的矩阵元：
- **目标**: 验证 $H_{ij} = \langle \psi_i | H | \psi_j \rangle$ 在 $8 \times 8$ 占据态空间的一致性。
- **关键点**: 验证复数内积的归一化因子。

---
**核准**: Gemini Agent
**存档**: `/workplace/chenys/project/DFTcu/docs/PHASE3_NL_OPERATOR_ALIGNMENT.md`
