/**
 * \page blog_convergence ç®—æ³•æ”¶æ•›æ€§åˆ†ææŠ¥å‘Š
 */
# TN ä¼˜åŒ–å™¨æ”¶æ•›èƒ½é‡å·®å¼‚æ·±åº¦åˆ†ææŠ¥å‘Š

## ğŸ“Š é—®é¢˜é™ˆè¿°

DFTcu çš„ Truncated Newton (TN) ä¼˜åŒ–å™¨ä¸ DFTpy åœ¨ **æœ€ç»ˆæ”¶æ•›èƒ½é‡** ä¸Šå­˜åœ¨ **3.62Ã—10â»âµ Ha** çš„å·®å¼‚ï¼Œè™½ç„¶ï¼š
- âœ… åˆå§‹èƒ½é‡å¯¹é½ï¼š< 10â»Â¹â° Ha
- âœ… ç¬¬ä¸€æ­¥è¿­ä»£å¯¹é½ï¼š10 ä½æœ‰æ•ˆæ•°å­—
- âŒ æœ€ç»ˆèƒ½é‡å·®å¼‚ï¼š3.62Ã—10â»âµ Haï¼ˆ**é«˜äºé¢„æœŸ**ï¼‰

## ğŸ”¬ å®éªŒæ•°æ®

### æ”¶æ•›è¡Œä¸ºå¯¹æ¯”

| æŒ‡æ ‡ | DFTpy | DFTcu | å·®å¼‚/è¯´æ˜ |
|-----|-------|-------|----------|
| **æ”¶æ•›æ­¥æ•°** | 28 æ­¥ | 25 æ­¥ | DFTcu æå‰ 3 æ­¥æ”¶æ•› |
| **æœ€ç»ˆèƒ½é‡** | -2.3207505408 Ha | -2.3207143042 Ha | **Î” = 3.62Ã—10â»âµ Ha** |
| **æ”¶æ•›åˆ¤æ®** | `econv = 1e-7` Ha | `econv = 1e-7` Ha | ç›¸åŒ |
| **æœ€åä¸€æ­¥ dE** | 1.46Ã—10â»â¸ Ha | 4.12Ã—10â»â¸ Ha | éƒ½æ»¡è¶³æ”¶æ•› |
| **Step 1 èƒ½é‡** | -2.117703861804 Ha | -2.1177038618 Ha | âœ… 10ä½å¯¹é½ |

### å…³é”®æ­¥éª¤èƒ½é‡æ¼”åŒ–

#### DFTcu çš„å¼‚å¸¸è¡Œä¸ºï¼š

```
Step 21: -2.3206665222 Ha  (dE: -1.81e-05) â† ä»åœ¨å¿«é€Ÿä¸‹é™
Step 22: -2.3206792800 Ha  (dE: -1.28e-05) â† æŒç»­ä¸‹é™
Step 23: -2.3206912081 Ha  (dE: -1.19e-05) â† æŒç»­ä¸‹é™
Step 24: -2.3206982271 Ha  (dE: -7.02e-06) â† å¼€å§‹æ”¾ç¼“
Step 25: -2.3207143042 Ha  (dE: -4.12e-08) â† çªç„¶æ”¶æ•› âŒ
         æ”¶æ•›åˆ¤å®šè§¦å‘ï¼Œåœæ­¢ä¼˜åŒ–
```

**å…³é”®é—®é¢˜**ï¼šStep 24â†’25 çš„èƒ½é‡å¢ç›Šä»æœ‰ **1.61Ã—10â»âµ Ha**ï¼Œä½† `dE` è®¡ç®—é”™è¯¯å¯¼è‡´è¯¯åˆ¤ä¸ºæ”¶æ•›ã€‚

#### DFTpy çš„æ­£å¸¸è¡Œä¸ºï¼š

```
Step 21: -2.320743045121 Ha (dE: -6.18e-06) â† å¼€å§‹æ”¾ç¼“
Step 22: -2.320746456853 Ha (dE: -3.41e-06) â† ç»§ç»­æ”¾ç¼“
Step 23: -2.320747402284 Ha (dE: -9.45e-07) â† æ¥è¿‘æ”¶æ•›
Step 24: -2.320749371972 Ha (dE: -1.97e-06) â† å¾®å°æ³¢åŠ¨
Step 25: -2.320750204306 Ha (dE: -8.32e-07) â† ç»§ç»­ä¼˜åŒ–
Step 26: -2.320750469782 Ha (dE: -2.65e-07) â† é€æ¸é€¼è¿‘
Step 27: -2.320750526259 Ha (dE: -5.65e-08) â† éå¸¸æ¥è¿‘
Step 28: -2.320750540831 Ha (dE: -1.46e-08) â† æ”¶æ•› âœ…
         è¿ç»­ ncheck=2 æ­¥æ»¡è¶³ dE < 1e-7
```

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### åŸå›  1ï¼šæ­¥æ•°è®¡æ•°é”™è¯¯å¯¼è‡´ dE è®¡ç®—å¼‚å¸¸ â­â­â­â­â­

#### é—®é¢˜å®šä½

è§‚å¯Ÿ DFTcu çš„è¾“å‡ºï¼š
```
Step    0 Energy:      -1.7256860666 dE: -1.7256860666e+00
Step    1 Energy:      -2.1177038618 dE: -3.9201779525e-01
...
Step   24 Energy:      -2.3206982271 dE: -7.0189235251e-06  â† æ­£å¸¸
Step   25 Energy:      -2.3207143042 dE: -4.1215161062e-08  â† å¼‚å¸¸å°ï¼
```

**è®¡ç®—éªŒè¯**ï¼š
```
å®é™…: E[25] - E[24] = -2.3207143042 - (-2.3206982271) = -1.6077Ã—10â»âµ Ha
æ˜¾ç¤º: dE = 4.12Ã—10â»â¸ Ha

é”™è¯¯ï¼dE åº”è¯¥æ˜¯ 1.61e-05ï¼Œä½†æ˜¾ç¤ºæˆäº† 4.12e-08
```

#### å¯èƒ½çš„ Bug

**çŒœæµ‹ 1: ç´¢å¼•åç§»é”™è¯¯**
```cpp
// âŒ é”™è¯¯å®ç°
double de = energy - energy_history[iter];  // åº”è¯¥æ˜¯ iter-1

// å½“ iter=25 æ—¶
de = energy[25] - energy[25] = 0  âŒ  // è‡ªå·±å‡è‡ªå·±
// æˆ–è€…å–åˆ°äº†é”™è¯¯çš„å†å²å€¼
```

**çŒœæµ‹ 2: èƒ½é‡å†å²è®°å½•æ—¶æœºé”™è¯¯**
```cpp
// âŒ é”™è¯¯é¡ºåº
energy_history.push_back(energy);  // å…ˆè®°å½•
double de = energy - energy_history[iter-1];  // åè®¡ç®—

// å¦‚æœ push_back çš„ä½ç½®ä¸å¯¹ï¼Œiter-1 å¯èƒ½å–åˆ°å½“å‰èƒ½é‡
```

**çŒœæµ‹ 3: Step è®¡æ•°ä¸æ•°ç»„ç´¢å¼•ä¸ä¸€è‡´**
```cpp
// âŒ Step ä» 0 å¼€å§‹ï¼Œä½†æŸå¤„ç”¨äº†ä» 1 å¼€å§‹çš„å‡è®¾
for (int step = 0; step < max_iter; ++step) {
    // ...
    if (step >= 1) {  // è¿™é‡Œå‡è®¾ step 1 å¯¹åº” index 1
        double de = energy - energy_history[step];  // âŒ åº”è¯¥æ˜¯ [step-1]
    }
}
```

#### ä¸ºä»€ä¹ˆ Step 24 ä¹‹å‰æ­£å¸¸ï¼Ÿ

å¯èƒ½çš„è§£é‡Šï¼š
```cpp
// å¯èƒ½çš„å®ç°ï¼ˆä¼ªä»£ç ï¼‰
if (iter < some_threshold) {
    de = correct_calculation();  // å‰ 24 æ­¥æ­£ç¡®
} else {
    de = buggy_calculation();     // ç¬¬ 25 æ­¥è§¦å‘ bug
}

// æˆ–è€…ä¸ Hessian é‡ç½®é€»è¾‘ç›¸å…³
if (need_reset_hessian) {
    // æŸäº›å˜é‡è¢«é‡ç½®ï¼Œå¯¼è‡´ energy_history ç´¢å¼•é”™ä½
}
```

---

### åŸå›  2ï¼šLine Search åœ¨å±€éƒ¨å¹³å¦åŒºåŸŸè¿‡æ—©åœæ­¢ â­â­â­â­

#### ç°è±¡

DFTpy è¾“å‡ºä¸­é¢‘ç¹å‡ºç°è­¦å‘Šï¼š
```
!WARN : pAp small than zero :iter = 12 -4.728746190949928
```

è¿™è¡¨æ˜ **Hessian è¿‘ä¼¼çŸ©é˜µå¤±å»æ­£å®šæ€§**ï¼Œæ­¤æ—¶ï¼š
- æœç´¢æ–¹å‘å¯èƒ½ä¸å†æ˜¯ä¸‹é™æ–¹å‘
- Line search å¯èƒ½æ‰¾åˆ°ä¸€ä¸ª **éç‚¹** è€Œéæœ€ä¼˜ç‚¹

#### DFTpy çš„å¤„ç†ç­–ç•¥

```python
# external/DFTpy/src/dftpy/optimization/optimization.py (æ¨æµ‹)
if pAp < 0:
    # é‡ç½®ä¸ºæœ€é€Ÿä¸‹é™æ–¹å‘
    direction = -gradient
    # é‡æ–°åˆå§‹åŒ– Hessian è¿‘ä¼¼
    reset_hessian()
    warnings.warn(f"pAp small than zero: {pAp}")
```

#### DFTcu å¯èƒ½çš„é—®é¢˜

```cpp
// âŒ å¦‚æœ DFTcu æ²¡æœ‰æ­£ç¡®å¤„ç†è´Ÿæ›²ç‡
if (pAp < threshold) {
    // å¯èƒ½ç›´æ¥é€€å‡ºæˆ–ä½¿ç”¨é”™è¯¯çš„æ­¥é•¿
    return step_size;  // å±€éƒ¨æœ€ä¼˜
}

// âœ… æ­£ç¡®å¤„ç†
if (pAp < 0) {
    direction = -gradient;  // é‡ç½®æ–¹å‘
    reset_hessian_approximation();
    continue;  // é‡æ–°æœç´¢
}
```

#### ä¸ºä»€ä¹ˆå¯¼è‡´èƒ½é‡å·®å¼‚ï¼Ÿ

1. **å±€éƒ¨å¹³å¦åŒºåŸŸ**ï¼šåœ¨ Step 23-24 é™„è¿‘ï¼Œèƒ½é‡æ›²é¢å˜å¾—éå¸¸å¹³å¦
2. **Hessian å¤±æ•ˆ**ï¼špAp < 0 è¯´æ˜äºŒé˜¶è¿‘ä¼¼ä¸å†å¯é 
3. **DFTcu è¯¯åˆ¤**ï¼šå¦‚æœæ²¡æœ‰é‡ç½®ï¼Œline search å¯èƒ½åœåœ¨æ¬¡ä¼˜ä½ç½®
4. **ç´¯ç§¯åå·®**ï¼š3 æ­¥ Ã— ~1e-5 Ha/step â‰ˆ 3e-5 Ha æ€»å·®å¼‚ âœ…

---

### åŸå›  3ï¼šæ”¶æ•›åˆ¤æ®å®ç°å·®å¼‚ â­â­â­

#### DFTpy çš„æ”¶æ•›é€»è¾‘

```python
# éœ€è¦è¿ç»­ ncheck=2 æ­¥éƒ½æ»¡è¶³ |dE| < econv
def check_convergence(energy_history, ncheck=2, econv=1e-7):
    if len(energy_history) < ncheck + 1:
        return False

    for i in range(ncheck):
        de = abs(energy_history[-1-i] - energy_history[-2-i])
        if de >= econv:
            return False
    return True  # è¿ç»­ ncheck æ­¥éƒ½æ»¡è¶³
```

#### DFTcu å¯èƒ½çš„å®ç°

```cpp
// âŒ å¯èƒ½åªæ£€æŸ¥å•æ­¥
if (abs(de) < econv) {
    converged = true;  // å•æ­¥æ»¡è¶³å°±é€€å‡º
}

// âœ… æ­£ç¡®å®ç°ï¼ˆCGOptimizer ä¸­æœ‰ï¼Œä½† TNOptimizer å¯èƒ½ç¼ºå¤±ï¼‰
if (iter >= ncheck) {
    bool converged = true;
    for (int i = 0; i < ncheck; ++i) {
        if (abs(energy_history[energy_history.size()-1-i] -
                energy_history[energy_history.size()-2-i]) > econv) {
            converged = false;
            break;
        }
    }
}
```

#### å½±å“åˆ†æ

å¦‚æœ DFTcu åœ¨ Step 25 çœ‹åˆ° `dE = 4.12e-08 < 1e-7`ï¼Œç«‹å³åˆ¤å®šæ”¶æ•›ï¼š
- **DFTpy**ï¼šç»§ç»­æ£€æŸ¥ Step 26, 27, 28ï¼Œç¡®ä¿è¿ç»­ç¨³å®š
- **DFTcu**ï¼šç›´æ¥åœæ­¢ï¼Œé”™å¤±åç»­ä¼˜åŒ–æœºä¼š

---

### åŸå›  4ï¼šæ•°å€¼ç²¾åº¦ç´¯ç§¯è¯¯å·® â­â­

#### Hessian æ›´æ–°çš„è¯¯å·®ä¼ æ’­

TN ä¼˜åŒ–å™¨ä½¿ç”¨æœ‰é™å·®åˆ†æˆ– BFGS æ›´æ–° Hessianï¼š
```
H_{k+1} = H_k + Î”H  // æ¯æ­¥ç´¯ç§¯è¯¯å·®
```

ç»è¿‡ 25 æ­¥è¿­ä»£ï¼š
```
å•æ­¥è¯¯å·®: Îµ â‰ˆ 10â»Â¹âµ (åŒç²¾åº¦æœºå™¨ç²¾åº¦)
ç´¯ç§¯è¯¯å·®: Îµ_total â‰ˆ âˆšN Ã— Îµ â‰ˆ âˆš25 Ã— 10â»Â¹âµ â‰ˆ 5Ã—10â»Â¹âµ

ä½†è¿™ä¸è¶³ä»¥è§£é‡Š 3.6Ã—10â»âµ Ha çš„å·®å¼‚ âŒ
```

#### GPU vs CPU çš„æµ®ç‚¹å·®å¼‚

- **cuFFT** vs **numpy.fft**ï¼šæ¯æ¬¡ FFT æœ‰ ~10â»Â¹â´ çº§åˆ«å·®å¼‚
- ç»è¿‡ 25 æ­¥ Ã— æ¯æ­¥å¤šæ¬¡ FFTï¼šç´¯ç§¯åˆ° ~10â»Â¹Â³ ~ 10â»Â¹Â²
- ä»ä¸è¶³ä»¥è§£é‡Š 10â»âµ çº§åˆ«å·®å¼‚ âŒ

**ç»“è®º**ï¼šæ•°å€¼ç²¾åº¦ä¸æ˜¯ä¸»è¦åŸå› ã€‚

---

### åŸå›  5ï¼šCubic Line Search å®ç°ç»†èŠ‚å·®å¼‚ â­â­â­

#### DFTpy çš„ Line Search æµç¨‹

```python
# ValueAndDerivative æ¥å£
def cubic_line_search(func, grad, x0, direction):
    # 1. é‡‡æ · 3-4 ä¸ªç‚¹
    alphas = [0, alpha1, alpha2, alpha3]
    energies = [func(x0 + a*direction) for a in alphas]
    gradients = [grad(x0 + a*direction) for a in alphas]

    # 2. æ‹Ÿåˆä¸‰æ¬¡å¤šé¡¹å¼
    # E(Î±) â‰ˆ c0 + c1*Î± + c2*Î±Â² + c3*Î±Â³
    coeffs = fit_cubic(alphas, energies, gradients)

    # 3. æ±‚å¯¼æ‰¾æå°å€¼
    # dE/dÎ± = c1 + 2*c2*Î± + 3*c3*Î±Â² = 0
    alpha_min = solve_cubic_derivative(coeffs)

    # 4. Armijo å›æº¯ï¼ˆç¡®ä¿å……åˆ†ä¸‹é™ï¼‰
    if not armijo_condition(alpha_min):
        alpha_min *= backtrack_factor

    return alpha_min
```

#### DFTcu å¯èƒ½çš„ç®€åŒ–

```cpp
// âŒ å¯èƒ½ä½¿ç”¨ç®€å•çš„äºŒæ¬¡æ’å€¼
double alpha = simple_quadratic_interpolation(e0, e1, g0);
// ç²¾åº¦ä¸å¦‚ä¸‰æ¬¡æ’å€¼ï¼Œåœ¨å¹³å¦åŒºåŸŸå®¹æ˜“è¯¯åˆ¤

// âŒ æˆ–è€…ç¼ºå°‘ Armijo å›æº¯
if (!sufficient_decrease) {
    // DFTpy: å›æº¯é‡è¯•
    // DFTcu: å¯èƒ½ç›´æ¥æ¥å—æ¬¡ä¼˜æ­¥é•¿
}
```

#### ä¸ºä»€ä¹ˆåœ¨åæœŸå½±å“æ›´å¤§ï¼Ÿ

- **æ—©æœŸ**ï¼ˆStep 1-20ï¼‰ï¼šæ¢¯åº¦å¤§ï¼Œèƒ½é‡æ›²é¢é™¡å³­ï¼Œç®€å•æ–¹æ³•ä¹Ÿèƒ½æ‰¾åˆ°å¥½æ­¥é•¿
- **åæœŸ**ï¼ˆStep 21-25ï¼‰ï¼šèƒ½é‡æ›²é¢å¹³å¦ï¼Œä¸‰æ¬¡æ’å€¼ vs äºŒæ¬¡æ’å€¼å·®å¼‚æ˜¾è‘—

```
é™¡å³­åŒºåŸŸï¼š
  E
  |   \
  |    \___  â† äºŒæ¬¡å’Œä¸‰æ¬¡æ’å€¼éƒ½èƒ½æ‰¾åˆ°
  +-------> Î±

å¹³å¦åŒºåŸŸï¼š
  E
  |_____
  |     \___ â† ä¸‰æ¬¡æ’å€¼èƒ½æ‰¾åˆ°ï¼ŒäºŒæ¬¡æ’å€¼å¯èƒ½è¿‡æ—©åœæ­¢
  +-------> Î±
```

---

## ğŸ’¡ ç»¼åˆè¯Šæ–­

### æœ€å¯èƒ½çš„åŸå› ç»„åˆ

| åŸå›  | å¯èƒ½æ€§ | å½±å“é‡çº§ | è¯æ® |
|-----|-------|---------|------|
| **1. Step è®¡æ•°/dE è®¡ç®—é”™è¯¯** | â­â­â­â­â­ | **ç›´æ¥å¯¼è‡´** | Step 25 çš„ dE å¼‚å¸¸ |
| **2. Line Search åœ¨éç‚¹åœæ­¢** | â­â­â­â­ | ~1e-5 Ha | pAp < 0 è­¦å‘Š |
| **3. æ”¶æ•›åˆ¤æ®å•æ­¥æ£€æŸ¥** | â­â­â­ | æå‰ 3 æ­¥ | å®é™…æ”¶æ•›æ­¥æ•°å·®å¼‚ |
| **4. Cubic vs Quadratic æ’å€¼** | â­â­â­ | ~5e-6 Ha | åæœŸèƒ½é‡æ›²é¢å¹³å¦ |
| **5. æ•°å€¼ç²¾åº¦ç´¯ç§¯** | â­â­ | ~1e-12 Ha | ä¸è¶³ä»¥è§£é‡Š |

### æœ€ç»ˆåˆ¤æ–­

**ä¸»å¯¼å› ç´ **ï¼šåŸå›  1 (dE è®¡ç®—é”™è¯¯) + åŸå›  3 (æ”¶æ•›åˆ¤æ®)
- Step 25 çš„ dE è¢«é”™è¯¯è®¡ç®—ä¸º 4.12e-08ï¼ˆå®é™…åº”ä¸º 1.61e-05ï¼‰
- å•æ­¥æ£€æŸ¥ç«‹å³åˆ¤å®šæ”¶æ•›ï¼Œé”™å¤± Step 26-28 çš„ä¼˜åŒ–æœºä¼š
- å¦‚æœç»§ç»­ä¼˜åŒ– 3 æ­¥ï¼Œé¢„è®¡èƒ½æ¥è¿‘ DFTpy çš„ -2.3207505 Ha

**æ¬¡è¦å› ç´ **ï¼šåŸå›  2 (Line Search) + åŸå›  4 (æ’å€¼æ–¹æ³•)
- åœ¨ pAp < 0 æ—¶å¤„ç†ä¸å½“ï¼Œåœç•™åœ¨å±€éƒ¨æ¬¡ä¼˜
- å¹³å¦åŒºåŸŸçš„æ­¥é•¿é€‰æ‹©ä¸å¤Ÿç²¾ç¡®

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§ 1ï¼šä¿®å¤ dE è®¡ç®—é€»è¾‘ âœ…

```cpp
// æ£€æŸ¥ TNOptimizer::solve() ä¸­çš„èƒ½é‡å·®è®¡ç®—
// ç¡®ä¿ï¼š
double de = (iter > 0) ? (energy - energy_history[iter - 1]) : energy;

// è€Œä¸æ˜¯ï¼š
double de = energy - energy_history[iter];  // âŒ é”™è¯¯
```

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æ·»åŠ è°ƒè¯•è¾“å‡º
printf("Step %d: E=%.10f, E_prev=%.10f, dE=%.2e\n",
       iter, energy, energy_history[iter-1], de);
```

### ä¼˜å…ˆçº§ 2ï¼šå®ç°è¿ç»­æ”¶æ•›æ£€æŸ¥ âœ…

```cpp
// å‚è€ƒ CGOptimizer çš„å®ç°ï¼ˆoptimizer.cu:136-149ï¼‰
if (iter >= options_.ncheck) {
    bool converged = true;
    for (int i = 0; i < options_.ncheck; ++i) {
        double de_i = std::abs(
            energy_history[energy_history.size() - 1 - i] -
            energy_history[energy_history.size() - 2 - i]
        );
        if (de_i > options_.econv) {
            converged = false;
            break;
        }
    }
    if (converged) {
        std::cout << "#### Converged ####" << std::endl;
        break;
    }
}
```

### ä¼˜å…ˆçº§ 3ï¼šå¤„ç† Hessian è´Ÿæ›²ç‡ âœ…

```cpp
// åœ¨è®¡ç®— pAp åæ£€æŸ¥
double pAp = conjugate_direction.dot(Ap_product);
if (pAp < 1e-14 || pAp < 0) {
    // é‡ç½®ä¸ºæœ€é€Ÿä¸‹é™
    conjugate_direction = -gradient;
    reset_hessian_approximation();
    std::cerr << "WARN: pAp=" << pAp << ", reset to steepest descent\n";
    continue;
}
```

### ä¼˜å…ˆçº§ 4ï¼šæ”¹è¿› Line Search ç²¾åº¦ (å¯é€‰)

```cpp
// ä½¿ç”¨ä¸‰æ¬¡æ’å€¼è€ŒéäºŒæ¬¡æ’å€¼
double alpha = cubic_interpolation(
    e0, e_alpha, e_2alpha,  // èƒ½é‡é‡‡æ ·
    g0, g_alpha, g_2alpha   // æ¢¯åº¦é‡‡æ ·
);

// æ·»åŠ  Armijo æ¡ä»¶å›æº¯
const double c1 = 1e-4;  // Armijo å‚æ•°
while (!armijo_condition(alpha, c1)) {
    alpha *= 0.5;  // å›æº¯
}
```

---

## ğŸ“ éªŒè¯æ–¹æ¡ˆ

### æµ‹è¯• 1ï¼šæ‰“å°è¯¦ç»†æ­¥éª¤

```bash
# ä¿®æ”¹ TNOptimizerï¼Œæ·»åŠ è¯¦ç»†è¾“å‡º
for iter in range(max_iter):
    energy = evaluate()
    de = energy - energy_prev
    print(f"Step {iter:3d}: E={energy:.10f}, dE={de:.2e}, "
          f"E_hist[{iter-1}]={energy_history[iter-1]:.10f}")
```

**é¢„æœŸ**ï¼šå‘ç° Step 25 çš„ `energy_history[iter-1]` å–å€¼å¼‚å¸¸ã€‚

### æµ‹è¯• 2ï¼šå¼ºåˆ¶å¤šè¿è¡Œå‡ æ­¥

```cpp
// ä¸´æ—¶ä¿®æ”¹æ”¶æ•›æ¡ä»¶
if (converged && iter < 30) {
    std::cout << "Would converge at " << iter
              << ", but forcing continue...\n";
    converged = false;
}
```

**é¢„æœŸ**ï¼šèƒ½é‡ç»§ç»­ä¸‹é™åˆ°æ¥è¿‘ -2.32075 Haã€‚

### æµ‹è¯• 3ï¼šå¯¹æ¯”å•æ­¥è¡Œä¸º

```python
# åœ¨ Step 24â†’25 å‰åæ‰‹åŠ¨æ¯”è¾ƒ
dftcu_step24 = -2.3206982271
dftcu_step25 = -2.3207143042
dftpy_step24 = -2.320749371972

print(f"DFTcu Step 24â†’25: {dftcu_step25 - dftcu_step24:.2e}")
# åº”è¯¥è¾“å‡º -1.61e-05ï¼Œè€Œé -4.12e-08

print(f"DFTpy Step 24â†’25: {dftpy_step25 - dftpy_step24:.2e}")
# è¾“å‡º -8.32e-07ï¼ˆæ­£å¸¸ï¼‰
```

---

## ğŸ¯ é¢„æœŸä¿®å¤æ•ˆæœ

| ä¿®å¤é¡¹ | é¢„æœŸæ”¹å–„ |
|-------|---------|
| ä¿®å¤ dE è®¡ç®— | ä¸å†æå‰æ”¶æ•›ï¼Œç»§ç»­ä¼˜åŒ– |
| è¿ç»­æ”¶æ•›æ£€æŸ¥ | å¤šè¿è¡Œ 2-3 æ­¥ |
| å¤„ç†è´Ÿæ›²ç‡ | é¿å…é™·å…¥éç‚¹ |
| **æ€»è®¡** | **å·®å¼‚é™è‡³ < 1Ã—10â»â¶ Ha** âœ… |

---

## ğŸ“š å‚è€ƒä»£ç ä½ç½®

### DFTpy å®ç°
- **TN æ ¸å¿ƒ**ï¼š`external/DFTpy/src/dftpy/optimization/optimization.py`
  - `get_direction_TN()`: Hessian-vector product
  - `ValueAndDerivative`: Line search æ¥å£
  - æ”¶æ•›æ£€æŸ¥é€»è¾‘ï¼š`optimize_rho()` ä¸­çš„è¿ç»­ `ncheck` æ­¥åˆ¤å®š

### DFTcu å®ç°ï¼ˆéœ€è¦æ£€æŸ¥ï¼‰
- **CGOptimizer**ï¼š`src/solver/optimizer.cu:136-149`ï¼ˆâœ… å·²æ­£ç¡®å®ç°è¿ç»­æ£€æŸ¥ï¼‰
- **TNOptimizer**ï¼šéœ€è¦å®šä½å®ç°æ–‡ä»¶
  - æ£€æŸ¥ `energy_history` ç´¢å¼•é€»è¾‘
  - æ£€æŸ¥æ”¶æ•›åˆ¤æ®æ˜¯å¦å¯¹é½ CGOptimizer

---

## ğŸ ç»“è®º

**3.62Ã—10â»âµ Ha çš„èƒ½é‡å·®å¼‚ä¸æ˜¯ç²¾åº¦é—®é¢˜ï¼Œè€Œæ˜¯ç®—æ³•å®ç° bugï¼š**

1. âœ… **ä¸»å› **ï¼šStep è®¡æ•°æˆ– `dE` è®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´è¯¯åˆ¤æ”¶æ•›
2. âœ… **æ¬¡å› **ï¼šå•æ­¥æ”¶æ•›æ£€æŸ¥ï¼ˆåº”è¯¥æ˜¯è¿ç»­ `ncheck=2` æ­¥ï¼‰
3. âœ… **åŠ å‰§**ï¼šLine search åœ¨å¹³å¦åŒºåŸŸç²¾åº¦ä¸è¶³ï¼ŒHessian è´Ÿæ›²ç‡å¤„ç†ç¼ºå¤±

**ä¿®å¤ä¼˜å…ˆçº§**ï¼š
1. ğŸ”´ **ç«‹å³ä¿®å¤**ï¼š`dE = energy - energy_history[iter-1]`ï¼ˆè€Œé `[iter]`ï¼‰
2. ğŸ”´ **ç«‹å³ä¿®å¤**ï¼šå®ç°è¿ç»­ `ncheck` æ­¥æ”¶æ•›æ£€æŸ¥
3. ğŸŸ¡ **é‡è¦**ï¼šå¤„ç† `pAp < 0` æƒ…å†µï¼ˆé‡ç½®ä¸ºæœ€é€Ÿä¸‹é™ï¼‰
4. ğŸŸ¢ **æ”¹è¿›**ï¼šä½¿ç”¨ä¸‰æ¬¡æ’å€¼ + Armijo å›æº¯

**é¢„æœŸæ•ˆæœ**ï¼šä¿®å¤åï¼Œæœ€ç»ˆèƒ½é‡å·®å¼‚åº”é™è‡³ **< 1Ã—10â»â¶ Ha**ã€‚
